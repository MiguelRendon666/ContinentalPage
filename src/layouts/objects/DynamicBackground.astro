---
---

<div class="dynamic-background">
    <div id="dinamic_header">
        <slot></slot>
    </div>
</div>

<script>
  import Rellax from 'rellax';
  
  const bgContainer = document.querySelector('.dynamic-background');
  const headerElement = document.getElementById('dinamic_header');
  
  if (bgContainer && headerElement) {
    const documentHeight = Math.max(
      document.body.scrollHeight,
      document.documentElement.scrollHeight,
      document.body.offsetHeight,
      document.documentElement.offsetHeight
    );
    const viewportWidth = window.innerWidth;
    const headerHeight = headerElement.offsetHeight;
    const availableHeight = documentHeight - headerHeight;
    
    const itemCount = Math.floor(availableHeight / 400);
    console.log('availableHeight', availableHeight, 'Item Count:', itemCount);
    const positions: { top: number; left: number; width: number; height: number }[] = [];
    
    const checkOverlap = (top: number, left: number, width: number, height: number) => {
      const topPx = (top / 100) * availableHeight + headerHeight;
      const leftPx = (left / 100) * viewportWidth;
      
      const margin = 20; // Margen de seguridad entre elementos
      
      return positions.some(pos => {
        const posTopPx = (pos.top / 100) * availableHeight + headerHeight;
        const posLeftPx = (pos.left / 100) * viewportWidth;
        
        const overlap = !(
          topPx + height + margin < posTopPx ||
          topPx > posTopPx + pos.height + margin ||
          leftPx + width + margin < posLeftPx ||
          leftPx > posLeftPx + pos.width + margin
        );
        
        return overlap;
      });
    };
    
    for (let i = 0; i < itemCount; i++) {
      const wrapper = document.createElement('div');
      wrapper.className = 'bg-item-wrapper';
      
      const isLeft = i % 2 === 0;
      const isDot = i % 2 === 0;
      const size = isDot ? 256 : 250;
      
      let top = 5 + Math.random() * 90;
      let left = isLeft ? Math.random() * 35 : 65 + Math.random() * 35;
      let attempts = 0;
      
      while (checkOverlap(top, left, size, size) && attempts < 50) {
        top = 5 + Math.random() * 90;
        left = isLeft ? Math.random() * 35 : 65 + Math.random() * 35;
        attempts++;
      }
      
      const rotation = Math.random() * 360;
      const parallaxSpeed = -10 + Math.random() * 20; // Velocidad entre -10 y 10
      
      // Ajustar el top para que sea relativo al espacio disponible debajo del header
      const topPx = (top / 100) * availableHeight + headerHeight;
      const topPercent = (topPx / documentHeight) * 100;
      
      wrapper.style.cssText = `top: ${topPercent}%; left: ${left}%; transform: rotate(${rotation}deg);`;
      wrapper.setAttribute('data-rellax-speed', parallaxSpeed.toFixed(1));
      
      const itemDiv = document.createElement('div');
      itemDiv.className = isDot ? 'dot-bg-item' : 'square-bg-item';
      
      wrapper.appendChild(itemDiv);
      bgContainer.appendChild(wrapper);
      
      positions.push({ top, left, width: size, height: size });
    }
    
    // Inicializar Rellax despuÃ©s de crear todos los elementos
    new Rellax('.bg-item-wrapper', {
      center: false,
      round: true,
      vertical: true,
      horizontal: false
    });
  }
</script>

<style is:global>
  .dynamic-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    min-height: 100%;
    background-color: transparent;
    z-index: -10;
    pointer-events: none;
    overflow: hidden;
  }

  .bg-item-wrapper {
    position: absolute;
  }
  .bg-item-wrapper * { isolation: isolate; }

  .dot-bg-item {
    opacity: 0.03;
    width: 256px;
    height: 256px;
    background-image: url('/assets/dot.png');
  }

  .square-bg-item {
    opacity: 0.05;
    width: 250px;
    height: 250px;
    background-image: url('/assets/rectangle.png');
  }
</style>